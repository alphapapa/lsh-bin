#!/bin/bash

# Setup
LOCAL_CMD=$0
REMOTE_CMD="ssh lsh.io bash --login rclip"
CMD_ARGS=""
FEEDBACK_CMD="true"

[[ -e `which notify-send` ]] && [[ -n $DISPLAY ]] && FEEDBACK_CMD="notify-send -a rclip"

CLIP_BASE="$HOME/rclip"

#USAGE: havearg arg $@
function havearg() {
    NEED=$1
    shift
    while [[ -n $1 ]]; do 
        [[ $1 == $NEED ]] && return 0
        shift
        done
    return 1
}       

# parse args
while [[ -n $1 ]]; do
    ARG=$1
    shift
    case $ARG in
        '-c') 
            CLIP_NAME=$1
            CLIP_BASE+="."
            CMD_ARGS+=" -c $CLIP_NAME"
            shift
        ;;
        *) 
            OP=$ARG
            break
        ;;
    esac
done

CLIP_FILE="${CLIP_BASE}${CLIP_NAME}.clip"
LOG_FILE="${CLIP_BASE}${CLIP_NAME}.log"

# hackily handle selection choice for copy/paste
case $1 in
    primary|secondary|clipboard)
        SELECTION=$1
        shift
    ;;
    *) SELECTION="clipboard" ;;
esac

LOCAL_CMD+=$CMD_ARGS
REMOTE_CMD+=$CMD_ARGS

# actually do anything
case $OP in
    copy) 
        $FEEDBACK_CMD "starting upload of $SELECTION"
        (xclip -o -selection $SELECTION | $LOCAL_CMD put $@ &&\
        $FEEDBACK_CMD "uploaded $SELECTION") ||\
        $FEEDBACK_CMD "failed to upload"
    ;;
    paste)
        $FEEDBACK_CMD "starting download of $SELECTION"
        ($LOCAL_CMD get $@ | xclip -i -selection $SELECTION &&\
        $FEEDBACK_CMD "downloaded clip to $SELECTION") ||\
        $FEEDBACK_CMD "failed to download."
    ;;
    put) $REMOTE_CMD local_put $@;;
    get) $REMOTE_CMD local_get $@;;
    note) echo -e "$@" | $LOCAL_CMD put -a;;
    tail) $REMOTE_CMD local_tail $@;;
    io)
        $LOCAL_CMD tail $@ &
        while read MSG; do
            echo "$MSG" | $LOCAL_CMD put $@
        done
        kill %1
    ;;
    local_put)
	DATE=`logdate`
        ID=`date '+%s.%N'`
        MUNGE='s/^\(.*\)$/data: \1/'
	if [[ $1 == '-a' ]]; then
            tee -a $CLIP_FILE | sed "$MUNGE" >> $LOG_FILE
        else
            printf "\nid: %s\ntime: %s\nmeta: %s\n" "$ID" "$DATE" "$*" >> $LOG_FILE
            tee $CLIP_FILE | sed "$MUNGE" >> $LOG_FILE
            printf "\n" >> $LOG_FILE
        fi
    ;;    
    local_get) cat $CLIP_FILE;;
    local_tail)
        if [[ $1 == '-raw' ]]; then
            shift
            tail $@ $LOG_FILE
        else
            IFS=''
            function extract_field() {
                printf "%s" "$PACKET" | grep "^$1: \\?" | sed "s/^$1: \\?//g"
            }

            (printf "\n"; tail $@ $LOG_FILE) | while read LINE; do
                if [[ -z $LINE ]]; then
                    if [[ -n $PACKET ]]; then
                        ID=$(extract_field id)
                        TIME=$(extract_field time)
                        META=$(extract_field meta)
                        DATA=$(extract_field data)
                        printf "`tput smso`    %s | %s    `tput rmso`\n%s\n\n" "$TIME" "$META" "$DATA"
                    fi    
                    PACKET=''
                else
                    PACKET+="$LINE"
                    PACKET+=$'\n'
                fi
            done
        fi                    
    ;;
    *) echo "Unrecognized subcommand $OP"; exit 1
esac
